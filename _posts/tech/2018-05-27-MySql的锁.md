---
layout: post
title:  MySql 中的锁设计
category: 技术基础
tags:MySql 锁
description:Mysql中的锁
---
 

Mysql 中提供了两种标准的行级锁。

- 共享锁 (S锁)

- 排它锁 (X锁)




#### 一致性非锁定读

指InnoDB引擎通过多版本控制的方式来读取当前执行时机数据库中的数据。如果读取的行正在执行delete或者update操作，这时候读操作不会等待行上的锁是否，相反会去读取一个快照数据。

非锁定读机制提高了数据库的并发性，InnoDb 存储引擎下这是默认的读取方式。

每行数据可能有多个版本，也就是多个快照数据，称这种技术为行多版本技术，由此带来的多并发控制(MVCC)



##### 乐观锁和MVCC

- 悲观锁

  		  在整个数据处理过程中，将数据处于锁定状态。悲观锁的实现，往往依靠数据库提供的锁机制（也只有数据库层提供的锁机制才能真正保证数据访问的排他性，否则，即使在本系统中实现了加锁机制，也无法保证外部系统不会修改数据）。

- 乐观锁

        乐观锁，大多是基于数据版本（ Version ）记录机制实现。何谓数据版本？即为数据增加一个版本标识，在基于数据库表的版本解决方案中，一般是通过为数据库表增加一个 “version”
        字段来实现。读取出数据时，将此版本号一同读出，之后更新时，对此版本号加一。此时，将提交数据的版本数据与数据库表对应记录的当前版本信息进行比对，如果提交的数据版本号大于数据库表当前版本号，则予以更新，否则认为是过期数据。

###### MVCC在Mysql的InnoDB实现

在InnoDB中，会在每行数据后添加两个额外的隐藏的值来实现MVCC，这两个值一个记录这行数据何时被创建，另外一个记录这行数据何时过期（或者被删除）。 

在实际操作中，存储的并不是时间，而是事务的版本号，每开启一个新事务，事务的版本号就会递增。 在可重读Repeatable reads事务隔离级别下：

    事务开始时刻的系统版本号作为事务的版本号，用来和查询到的每行记录的版本号进行比较。

    SELECT时，读取创建版本号<=当前事务版本号，删除版本号为空或>当前事务版本号。
    INSERT时，保存当前事务版本号为行的创建版本号
    DELETE时，保存当前事务版本号为行的删除版本号
    UPDATE时，插入一条新纪录，保存当前事务版本号为行创建版本号，同时保存当前事务版本号到原来删除的行


在不同的事务隔离级别下，快照数据的定义不同。

##### READ COMMITED

对于快照数据，非一致性读总是读取被锁定行的最新一份快照数据。

(出现 同一个事务下 两次读取的数据不一致,不可重复读)

##### REPETABLE READ

对于快照数据，非一致性读总是读取事务开始时的行数据版本。

(出现 同一个事务下读一个范围的数据，多次读取的结果的记录条数不一样 幻读，mysql 不会出现幻读,间隙锁)

行锁和间隙锁的结合称为Next-Key锁，保证MySQL在可重复读的隔离级别下，不会出现幻读





##### Serializable

全部串行化，锁表， X锁。



#### 一致性锁定读

     select ---- for update
     select ---- lock in share mode

#### 锁的算法

- 行锁

 行记录上的锁

- 间隙锁 

锁定一个范围，不包括记录本身

- Next-Key 锁


结合行锁和间隙锁的算法，解决幻读。

     select * from table where id>2 for Update
 
 在repeatable read 情况下，采用next-key 加锁，锁住的记录是(2,+OO).
 
 而在read commit 情况下，锁住的是取出的记录。


#### 锁带来的问题

##### 脏读

未提交的数据被读到了。


##### 不可重复读


一次事务中两次读取的数据不一样。


如果第二次读取的数据多了一条叫幻读。

next-key锁解决不可重复读

##### 丢失更新

事务之间的操作被覆盖。

使用排它锁 ，select for update 

#### 死锁

死锁是指两个或两个以上的事务在执行的过程中，因为竞争锁资源而造成的互相等待的状态。


##### 解决死锁的方法

- 超时

等待直接设置一个阀值，超时后，然后某个一个事务回滚，如果占用了许多undo log，造成回滚时间很久，就不适合了。

- wait-for graph(等待图)

 InnoDB也采用这种方式，等待图要求数据库保存以下两种信息。
 1. 锁的信息列表
 2. 事务的等待链表。
 
通过上述信息可以构造出一张图，如果存在回路，就存在死锁。

在等待图中，事务为图中的节点，事务T1指向t2的边定义为:事务T1等待事务T2所占用的资源。



#### 总结

Mysql的提供了两种标准的锁，排它锁和共享锁。在这基础上 发展出乐观锁和悲观锁。

在一致性非锁定读 基础上发展出多版本并发控制(MVCC)。

锁的算法有三种:行锁，间隙锁，next-key 锁。




---
layout: post
title: Mysql 索引
category: 技术基础
tags:  Mysql 索引,B+树
description:   Mysql 索引
---


#### 索引的本质

索引相当于一本书的目录，索引是一种数据结构，帮助快速定位到硬盘上的数据。


一张图
![image](http://7x00ae.com1.z0.glb.clouddn.com/%E7%B4%A2%E5%BC%95.png)

这是一种比较简单的索引，左边是一个二叉树，右边是硬盘上的数据，

通过在col1 上建立索引，能在O(log2n) 的时间复杂度内找到对应的数据。

##### 主键索引

指定某个字段为主键后，会隐含的新增一个唯一索引

##### 单列索引
在某个字段上建立索引

##### 复合索引

INDEX(a, b, c)可以当做a或(a, b)的索引来使用，但不能当作b、c或(b,c)的索引来使用。

##### 全文索引

mysql 5.6 的innodb版本以后支持




#### 数据结构

mysql等文件系统一般采用B树和B+树作为数据结构.

##### B-树
 是一种多路搜索树（并不是二叉的）：
 


    1.定义任意非叶子结点最多只有M个儿子；且M>2；

    2.根结点的儿子数为[2, M]；

    3.除根结点以外的非叶子结点的儿子数为[M/2, M]；

    4.每个结点存放至少M/2-1（取上整）和至多M-1个关键字；（至少2个关键字）

    5.非叶子结点的关键字个数=指向儿子的指针个数-1；

    6.非叶子结点的关键字：K[1], K[2], …, K[M-1]；且K[i] < K[i+1]；

    7.非叶子结点的指针：P[1], P[2], …, P[M]；其中P[1]指向关键字小于K[1]的

    子树，P[M]指向关键字大于K[M-1]的子树，其它P[i]指向关键字属于(K[i-1], K[i])的子树；

    8.所有叶子结点位于同一层,高度为h；

![image](http://7x00ae.com1.z0.glb.clouddn.com/b-%E6%A0%91.JPG)
##### B+树
 B+树 是B-树的变种。

     1.其定义基本与B-树同，除了：

     2.非叶子结点的子树指针与关键字个数相同；

     3.非叶子结点的子树指针P[i]，指向关键字值属于[K[i], K[i+1])的子树 (B-树是开区间);

     4.为所有叶子结点增加一个链指针；

     5.所有关键字都在叶子结点出现；

![image](http://7x00ae.com1.z0.glb.clouddn.com/B+%E6%A0%91.JPG)


#### 索引结构

B+树适合作为数据库的基础结构，完全是因为计算机的内存-机械硬盘两层存储结构。内存可以完成快速的随机访问（随机访问即给出任意一个地址，要求返回这个地址存储的数据）但是容量较小。而硬盘的随机访问要经过机械动作（1磁头移动 2盘片转动），访问效率比内存低几个数量级，但是硬盘容量较大。典型的数据库容量大大超过可用内存大小，这就决定了在B+树中检索一条数据很可能要借助几次磁盘IO操作来完成。如下图所示：通常向下读取一个节点的动作可能会是一次磁盘IO操作，不过非叶节点通常会在初始阶段载入内存以加快访问速度。同时为提高在节点间横向遍历速度，真实数据库中可能会将图中蓝色的CPU计算/内存读取优化成二叉搜索树。


![image](http://7x00ae.com1.z0.glb.clouddn.com/mysql%E6%90%9C%E7%B4%A2%E8%8A%82%E7%82%B9.png)

为什么使用B+树?就是因为：

1. 文件很大，不可能全部存储在内存中，故要存储到磁盘上
2. 索引的结构组织要尽量减少查找过程中磁盘I/O的存取次数(为什么使用B-/+Tree，还跟磁盘存取原理有关。)
3. 局部性原理与磁盘预读，预读的长度一般为页(page)的整倍数，(在许多操作系统中，页得大小通常为4k)
4. 数据库系统巧妙利用了磁盘预读原理，将一个节点的大小设为等于一个页，这样每个节点只需要一次I/O就可以完全载入，(由于节点中有两个数组，所以地址连续)。而红黑树这种结构，h明显要深的多。由于逻辑上很近的节点(父子)物理上可能很远，无法利用局部性
5. 


#### 索引实现

##### MyISAM

MyISAM引擎使用B+Tree作为索引结构，叶节点的data域存放的是数据记录的地址。

MyISAM的主键索引如图所示
![image](http://7x00ae.com1.z0.glb.clouddn.com/MyISAME%E7%B4%A2%E5%BC%95.png)


MyISAM中，主索引和辅助索引（Secondary key）在结构上没有任何区别，只是主索引要求key是唯一的，而辅助索引的key可以重复。


##### InnoDB
在InnoDB中，表数据文件本身就是按B+Tree组织的一个索引结构，这棵树的叶节点data域保存了完整的数据记录。这个索引的key是数据表的主键，因此InnoDB表数据文件本身就是主索引

InnoDB的主键索引如图所示

![image](http://7x00ae.com1.z0.glb.clouddn.com/InnoDB%E7%B4%A2%E5%BC%95.png)

辅助索引的叶子节点存储相应记录主键的值而不是地址，也就是说InnoDB的所有辅助索引都使用主键作为叶子节点。

所以在name上建立辅助索引然后 使用 where name='susan'查询 的时候会搜索两次索引，先使用索引name定位到主键索引23。然后遍历注解索引找到对应的数据。

明白InnoDB的索引实现后，就很容易明白为什么不建议使用过长的字段作为主键，因为所有辅助索引都引用主索引，过长的主索引会令辅助索引变得过大。再例如，用非单调的字段作为主键在InnoDB中不是个好主意，因为InnoDB数据文件本身是一颗B+Tree，非单调的主键会造成在插入新记录时数据文件为了维持B+Tree的特性而频繁的分裂调整，十分低效，而使用自增字段作为主键则是一个很好的选择。


	ab联合索引就是先在a上生成btree索引，按a值大小排序的。a值相同的情况下在b上生成btree索引
	所以有个左前缀规则，查询的时候先找到a，再找b


#### 总结

通过了解Mysql 索引的结构，能帮助在写出高质量sql语句，使用好Mysql的索引和最左匹配原则对于查询速度有很大的提升。